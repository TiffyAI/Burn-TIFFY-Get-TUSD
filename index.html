<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>TiffyAI Empire â€” Burn & Redeem (Fixed UI)</title>
  <style>
    :root{
      --electric-blue:#00d9ff;
      --shocking-pink:#ff007f;
      --glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:18px;
      background:linear-gradient(135deg,#07030a 0%,#12002b 70%);
      font-family:Inter,Segoe UI,Arial,sans-serif;
      color:#e6fbff;
    }
    .container{width:100%;max-width:460px}
    h1{margin:0 0 8px;color:var(--shocking-pink);text-shadow:0 0 18px var(--shocking-pink),0 0 36px var(--electric-blue);font-size:20px;text-align:center}
    .card{
      background:var(--glass);
      border-radius:14px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      margin-bottom:14px;
    }
    .small{font-size:13px;color:#cfe;margin-bottom:8px}
    label{display:block;margin-top:8px;margin-bottom:6px;font-size:13px;color:#bfe}
    input[type=number], .input {
      width:100%; padding:11px 12px; border-radius:10px; border:none;
      background:rgba(0,0,0,0.45); color:#fff; font-size:15px; outline:none;
    }
    .btn {
      width:100%; padding:12px; border-radius:10px; border:none; cursor:pointer;
      font-weight:700; color:#071017; margin-top:10px;
      background:linear-gradient(90deg,var(--electric-blue),var(--shocking-pink));
    }
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .balance{color:var(--electric-blue);font-weight:700}
    .tusd{color:var(--shocking-pink);font-weight:700}
    .gas {margin-top:8px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:13px}
    .history{max-height:240px;overflow:auto;padding:8px;border-radius:8px;background:rgba(0,0,0,0.2);margin-top:8px}
    .tx{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);font-size:13px;color:#def}
    .link{color:var(--electric-blue);text-decoration:none}
    @media(max-width:420px){ .card{padding:12px} h1{font-size:18px} }
  </style>
</head>
<body>
  <div class="container">
    <h1>TiffyAI Empire âš¡ â€” Burn & Redeem</h1>

    <div class="card" id="mainCard">
      <div class="small" style="text-align:center">
        Burn TIFFY â†’ Receive TUSD (target peg 1 TIFFY â†’ 20 TUSD)<br>
        Contract: <a id="explorerLink" class="link" href="#" target="_blank" rel="noopener">(swap contract)</a>
      </div>

      <button id="connectBtn" class="btn">ðŸ”— Connect Wallet</button>

      <label>Amount to burn (TIFFY) â€” <span style="color:#ffd">min 1 TIFFY</span></label>
      <input id="burnAmount" type="number" step="1" min="1" placeholder="Enter whole TIFFY amount (1, 2, 3...)" />

      <div class="row">
        <div class="small">You will receive (preview)</div>
        <div id="tusdPreview" class="tusd">0 TUSD</div>
      </div>

      <button id="estimateBtn" class="btn" disabled>âš¡ Estimate Gas</button>
      <button id="redeemBtn" class="btn" disabled>ðŸ”¥ Burn & Redeem</button>

      <div class="row" style="margin-top:10px">
        <div>
          <div class="small">TIFFY Balance</div>
          <div id="tiffyBal" class="balance">â€”</div>
        </div>
        <div>
          <div class="small">TUSD Balance (you)</div>
          <div id="tusdBal" class="tusd">â€”</div>
        </div>
      </div>

      <div id="gasInfo" class="gas">Estimate will appear here</div>
      <div id="status" class="small" style="margin-top:8px">Status: idle</div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Local Transaction History</div>
        <button id="clearHistory" class="btn" style="width:auto;padding:6px 10px;background:rgba(255,255,255,0.06)">Clear</button>
      </div>
      <div id="historyList" class="history"></div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
<script>
/* ========== CONFIG ========== */
const SWAP_CONTRACT_ADDRESS = "0xEc7B2ebe558424d0d3929c581e0018d2bEDe8eF6"; // your swap contract
const TIFFY_ADDRESS = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
const OWNER_ADDRESS = "0x2a234d5cc7431b824723c84c8605fd3968bf0255".toLowerCase();
const RATE = 20; // 1 TIFFY -> 20 TUSD (business rule)
const ADJUSTMENT_DIV = "1000000000000000000"; // divide input units by 1e18 before sending to contract (workaround)

/* ========== ABIs ========== */
const ERC20_ABI = [
  { "constant":true,"inputs":[{"name":"_owner","type":"address"}],"name":"balanceOf","outputs":[{"name":"balance","type":"uint256"}],"type":"function" },
  { "constant":false,"inputs":[{"name":"_spender","type":"address"},{"name":"_value","type":"uint256"}],"name":"approve","outputs":[{"name":"","type":"bool"}],"type":"function" }
];
const SWAP_ABI = [
  { "inputs":[{"name":"amount","type":"uint256"}],"name":"redeemTiffy","outputs":[],"stateMutability":"nonpayable","type":"function" },
  { "inputs":[],"name":"swapSkimToUSDT","outputs":[],"stateMutability":"nonpayable","type":"function" }
];

/* ========== UI elements ========== */
const connectBtn = document.getElementById('connectBtn');
const estimateBtn = document.getElementById('estimateBtn');
const redeemBtn = document.getElementById('redeemBtn');
const burnInput = document.getElementById('burnAmount');
const tusdPreview = document.getElementById('tusdPreview');
const tiffyBalEl = document.getElementById('tiffyBal');
const tusdBalEl = document.getElementById('tusdBal');
const gasInfo = document.getElementById('gasInfo');
const statusEl = document.getElementById('status');
const historyList = document.getElementById('historyList');
const clearHistoryBtn = document.getElementById('clearHistory');
const explorerLink = document.getElementById('explorerLink');
explorerLink.href = `https://bscscan.com/address/${SWAP_CONTRACT_ADDRESS}`;

/* ========== State ========== */
let web3, userAddr, tiffyContract, swapContract;

/* ========== Helpers ========== */
function setStatus(msg){ statusEl.innerText = 'Status: ' + msg; }
function bn(v){ return web3.utils.toBN(String(v)); }
function pow10(e){ return web3.utils.toBN(10).pow(web3.utils.toBN(e)); }
function toWei(valStr){ return web3.utils.toWei(String(valStr)); }
function storeTx(record){
  const list = JSON.parse(localStorage.getItem('tiffy_history')||'[]');
  list.unshift(record);
  if(list.length>200) list.pop();
  localStorage.setItem('tiffy_history', JSON.stringify(list));
  renderHistory();
}
function renderHistory(){
  const list = JSON.parse(localStorage.getItem('tiffy_history')||'[]');
  if(!list.length){ historyList.innerHTML = '<div class="small">No history yet</div>'; return; }
  historyList.innerHTML = list.map(r=>{
    return `<div class="tx"><div style="font-weight:700">${r.type} ${r.amount} TIFFY â†’ ${r.tusd} TUSD</div>
      <div class="small">${new Date(r.ts).toLocaleString()} â€¢ ${r.status}</div>
      <div style="margin-top:6px;"><a class="link" href="https://bscscan.com/tx/${r.txHash}" target="_blank">${r.txHash? r.txHash.slice(0,10)+'...' : 'pending'}</a></div></div>`;
  }).join('');
}

/* ========== Connect & Setup ========== */
async function connectWallet(auto=false){
  if(!window.ethereum){ setStatus('MetaMask not found'); return; }
  web3 = new Web3(window.ethereum);
  try{
    const accs = auto ? await window.ethereum.request({method:'eth_accounts'}) : await window.ethereum.request({method:'eth_requestAccounts'});
    if(!accs || accs.length===0){ if(!auto) setStatus('User did not connect'); return; }
    userAddr = accs[0];
    tiffyContract = new web3.eth.Contract(ERC20_ABI, TIFFY_ADDRESS);
    swapContract = new web3.eth.Contract(SWAP_ABI, SWAP_CONTRACT_ADDRESS);
    connectBtn.innerText = 'âœ… Connected';
    estimateBtn.disabled = false;
    redeemBtn.disabled = false;
    setStatus('Connected: ' + userAddr.slice(0,10) + '...');
    await refreshBalances();
    // enable owner UI if owner
    if(userAddr.toLowerCase() === OWNER_ADDRESS) {
      // nothing else to do; owner functions called from console or future UI
    }
    // auto refresh balances
    setInterval(()=>{ refreshBalances().catch(()=>{}); }, 15000);
    // watch account changes
    window.ethereum.on('accountsChanged', (accounts)=>{ if(accounts.length){ userAddr = accounts[0]; connectWallet(true); } else { userAddr = null; setStatus('Disconnected'); } });
  }catch(e){ setStatus('Connect failed: '+(e.message||e)); console.error(e); }
}
window.addEventListener('load', ()=> connectWallet(true));

/* ========== Balances & Preview ========== */
async function refreshBalances(){
  if(!userAddr || !tiffyContract) return;
  try{
    const raw = await tiffyContract.methods.balanceOf(userAddr).call();
    const human = Number(web3.utils.fromWei(raw)).toFixed(4);
    tiffyBalEl.innerText = `${human} TIFFY`;
  }catch(e){ tiffyBalEl.innerText = 'N/A'; }
  // TUSD balance is unknown token in your contract; we show N/A (can be wired if you set TUSD token address)
  tusdBalEl.innerText = 'N/A';
  updatePreview();
}

function updatePreview(){
  const v = parseInt(burnInput.value) || 0;
  const preview = v * RATE;
  tusdPreview.innerText = preview.toLocaleString(undefined, {maximumFractionDigits:6}) + ' TUSD';
}

/* ========== Workaround conversion ==========
   Your deployed contract multiplies input by 1e18 mistakenly.
   We compensate by dividing the wei units by 1e18 (integer division)
   BEFORE sending to redeemTiffy().
   This makes whole TIFFY amounts produce correct 20*TUSD outputs.
   NOTE: fractional TIFFY (<1) will be floored to 0 and not allowed.
   ============================================ */
function unitsAdjustedForBug(unitsWeiStr){
  // unitsWeiStr is a decimal string in wei (e.g., "1000000000000000000" for 1 TIFFY)
  // compute adjusted = floor(unitsWei / 1e18)
  const unitsBN = web3.utils.toBN(unitsWeiStr);
  const adj = unitsBN.div(web3.utils.toBN(ADJUSTMENT_DIV)); // integer division
  return adj; // BN
}

/* ========== Gas estimate handler ========= */
estimateBtn.addEventListener('click', async ()=>{
  try{
    if(!userAddr) { setStatus('Connect wallet'); return; }
    const amt = parseInt(burnInput.value) || 0;
    if(amt < 1){ setStatus('Minimum 1 TIFFY due to current contract fix'); return; }
    setStatus('Estimating gas...');
    const unitsWei = web3.utils.toWei(String(amt));
    const adjusted = unitsAdjustedForBug(unitsWei);
    if(adjusted.isZero()){ setStatus('Adjusted units = 0 (increase amount)'); return; }
    // encode call
    const data = swapContract.methods.redeemTiffy(adjusted.toString()).encodeABI();
    const tx = { from: userAddr, to: SWAP_CONTRACT_ADDRESS, data };
    const gas = await web3.eth.estimateGas(tx);
    const gasPrice = await web3.eth.getGasPrice();
    const feeBN = web3.utils.toBN(gas).mul(web3.utils.toBN(gasPrice));
    const feeEth = web3.utils.fromWei(feeBN);
    gasInfo.innerText = `Estimated gas: ${gas} â€¢ gasPrice: ${web3.utils.fromWei(gasPrice)} wei â€¢ est fee (BNB): ${Number(feeEth).toFixed(6)}`;
    setStatus('Gas estimate ready');
  }catch(e){ setStatus('Estimate failed: '+(e.message||e)); console.error(e); }
});

/* ========== Redeem (Approve -> Redeem) ========= */
redeemBtn.addEventListener('click', async ()=>{
  try{
    if(!userAddr){ setStatus('Connect wallet'); return; }
    const amt = parseInt(burnInput.value) || 0;
    if(amt < 1){ setStatus('Minimum 1 TIFFY required'); return; }

    setStatus('Preparing redeem...');
    const unitsWei = web3.utils.toWei(String(amt));               // e.g. 1 TIFFY -> 1e18
    const adjustedBN = unitsAdjustedForBug(unitsWei);            // e.g. 1e18 / 1e18 -> 1 (BN)
    if(adjustedBN.isZero()){ setStatus('Adjusted units zero â€” increase amount'); return; }

    // Approve TIFFY for original unitsWei (contract will burn, but we send adjusted to match mint)
    setStatus('Sending approve (confirm in wallet)...');
    const approveReceipt = await tiffyContract.methods.approve(SWAP_CONTRACT_ADDRESS, unitsWei).send({ from: userAddr });
    setStatus('Approve confirmed: ' + (approveReceipt.transactionHash||'pending'));

    // Final confirmation
    if(!confirm(`Confirm burn: ${amt} TIFFY â†’ ${amt*RATE} TUSD (preview). Proceed?`)){ setStatus('User cancelled'); return; }

    setStatus('Sending redeemTiffy (confirm in wallet)...');
    const tx = await swapContract.methods.redeemTiffy(adjustedBN.toString()).send({ from: userAddr });
    const txHash = tx.transactionHash || tx.transactionHash;
    storeTx({ txHash, type: 'BURN', amount: amt, tusd: amt*RATE, ts: Date.now(), status: 'confirmed' });
    setStatus('Burn confirmed: ' + txHash);
    await refreshBalances();
  }catch(e){
    setStatus('Redeem failed: ' + (e.message||e));
    console.error(e);
    // store failed tx (if any)
    storeTx({ txHash: null, type: 'BURN', amount: burnInput.value || '-', tusd: (burnInput.value||0)*RATE, ts: Date.now(), status: 'failed' });
  }
});

/* ========== Owner: swapSkimToUSDT (UI only) ========= */
async function ownerCashOut(){
  if(!userAddr) { setStatus('Connect wallet'); return; }
  if(userAddr.toLowerCase() !== OWNER_ADDRESS){ setStatus('Not owner'); return; }
  try{
    setStatus('Calling swapSkimToUSDT (confirm in wallet)...');
    const receipt = await swapContract.methods.swapSkimToUSDT().send({ from: userAddr });
    storeTx({ txHash: receipt.transactionHash, type: 'SKIM', amount: '-', tusd: '-', ts: Date.now(), status: 'confirmed' });
    setStatus('Skim cashed out: ' + receipt.transactionHash);
  }catch(e){ setStatus('Skim failed: '+(e.message||e)); console.error(e); }
}

/* ========== Misc UI wiring ========== */
burnInput.addEventListener('input', updatePreview);
connectBtn.addEventListener('click', ()=>connectWallet(false));
clearHistoryBtn.addEventListener('click', ()=>{ localStorage.removeItem('tiffy_history'); renderHistory(); setStatus('History cleared'); });

/* ========== Auto connect attempt on load ========== */
(async function autoConnect(){
  if(!window.ethereum) return;
  try{
    web3 = new Web3(window.ethereum);
    const accs = await window.ethereum.request({ method: 'eth_accounts' });
    if(accs && accs.length>0){ await connectWallet(true); }
  }catch(e){ /* ignore */ }
})();

/* ========== Initial render ========== */
renderHistory();
setStatus('Idle â€” connect wallet');
</script>
</body>
</html>
